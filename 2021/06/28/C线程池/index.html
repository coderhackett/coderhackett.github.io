<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>C线程池 | 加班猿</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.8.2/mermaid.min.js"></script><script>mermaid.initialize({
  startOnLoad: true
  , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.2.0"></head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2021-06-27T16:00:00.000Z" id="date"> 2021-06-28</time></span><br><span>updated:<time datetime="2021-06-30T15:24:47.085Z" id="updated"> 2021-06-30</time></span></div><h1>C线程池</h1><hr></div><div id="post-content"><p><img src="https://img-blog.csdnimg.cn/20201029203102512.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzM3ODI0MzU3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<div align = 'right'>作者：hackett</div>

<div align = 'right'>微信公众号：加班猿</div>



<h1 id="C线程池"><a href="#C线程池" class="headerlink" title="C线程池"></a>C线程池</h1><h2 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h2><h3 id="查看线程相关接口函数："><a href="#查看线程相关接口函数：" class="headerlink" title="查看线程相关接口函数："></a>查看线程相关接口函数：</h3><h4 id="线程创建"><a href="#线程创建" class="headerlink" title="线程创建"></a>线程创建</h4><p>int pthread_create(pthread_t *thread, const pthread_attr_t *attr,<br>                          void *(*start_routine) (void *), void *arg);</p>
<p>参数说明：</p>
<p>1.参数thread指向存放新创建线程的线程ID的地址</p>
<p>2.attr参数用于定制各种不同的线程属性，暂可以把它设置为NULL，以创建默认属性的线程。</p>
<p>3.start_routine是个函数指针，该函数返回类型是void<em>，同时形式参数也是void</em>。新创建的线程从start_routine函数的地址开始运行。该函数只有一个无类型指针参数arg.如果需要向start_routine函数传递的参数不止一个，那么需要把这些参数放到一个结构中，然后把这个结构的地址作为arg参数传入。</p>
<p>返回值：</p>
<p>线程创建成功返回0，失败返回其他数值</p>
<h4 id="线程退出"><a href="#线程退出" class="headerlink" title="线程退出"></a>线程退出</h4><p>void pthread_exit(void *retval);</p>
<p>参数说明：</p>
<p>retval是一个无类型指针，进程中的其他线程可以通过调用pthread_join函数访问到这个指针。</p>
<h4 id="线程等待"><a href="#线程等待" class="headerlink" title="线程等待"></a>线程等待</h4><p>int pthread_join(pthread_t thread, void **retval);</p>
<p>参数说明：</p>
<p>调用这个函数的线程将一直阻塞，直到指定的线程调用pthread_exit. 如果对线程的返回值不感兴趣，可以把retval置为NULL。在这种情况下，调用pthread_join函数将等待指定的线程终止，但并不获得线程的终止状态。</p>
<h4 id="线程取消"><a href="#线程取消" class="headerlink" title="线程取消"></a>线程取消</h4><p>int pthread_cancel(pthread_t thread)；</p>
<p>参数说明：</p>
<p>thread为线程的id</p>
<h4 id="设置线程的cancle信号"><a href="#设置线程的cancle信号" class="headerlink" title="设置线程的cancle信号"></a>设置线程的cancle信号</h4><p>int pthread_setcancelstate(int state,   int *oldstate) ； </p>
<p>PTHREAD_CANCEL_ENABLE：线程可取消。这是所有新线程的默认取消状态，包括初始线程。线程的可取消类型决定了可取消线程何时响应取消请求。</p>
<p>PTHREAD_CANCEL_DISABLE：线程不可取消。如果收到一个取消请求，它将被阻塞，直到可取消启用。</p>
<h4 id="清理线程"><a href="#清理线程" class="headerlink" title="清理线程"></a>清理线程</h4><p>void pthread_cleanup_push(void (*rtn)(void *), void *arg);</p>
<p>参数说明：</p>
<p>void(*rtn)(void *):线程清理函数</p>
<p>arg传递的参数</p>
<h4 id="激活所有等待线程"><a href="#激活所有等待线程" class="headerlink" title="激活所有等待线程"></a>激活所有等待线程</h4><p>pthread_cond_broadcast(pthread_cond_t *cond);</p>
<h3 id="查看互斥锁相关接口函数："><a href="#查看互斥锁相关接口函数：" class="headerlink" title="查看互斥锁相关接口函数："></a>查看互斥锁相关接口函数：</h3><h4 id="创建互斥锁"><a href="#创建互斥锁" class="headerlink" title="创建互斥锁"></a>创建互斥锁</h4><p>int pthread_mutex_init(pthread_mutex_t *restrict mutex,const pthread_mutexattr_t *restrict attr);</p>
<p>参数说明：</p>
<p>1.在使用互斥锁前，需要定义互斥锁(全局变量)，定义互斥锁对象形式为：pthread_mutex_t lock;</p>
<p>2.mutex 是个指针，指向需要初始化的互斥锁；</p>
<p>3.参数attr指定了新建互斥锁的属性。如果参数attr为NULL，则使用默认的互斥锁属性，默认属性为快速互斥锁 。</p>
<h4 id="销毁互斥锁"><a href="#销毁互斥锁" class="headerlink" title="销毁互斥锁"></a>销毁互斥锁</h4><p><strong>int</strong> pthread_mutex_destroy(pthread_mutex_t *mutex);</p>
<p>参数说明:</p>
<p>mutex为需要销毁的互斥锁；</p>
<h4 id="上互斥锁"><a href="#上互斥锁" class="headerlink" title="上互斥锁"></a>上互斥锁</h4><p>int pthread_mutex_lock(pthread_mutex_t *mutex);</p>
<p>参数说明:</p>
<p>mutex为需要加锁的互斥锁；</p>
<h4 id="解互斥锁"><a href="#解互斥锁" class="headerlink" title="解互斥锁"></a>解互斥锁</h4><p>int pthread_mutex_unlock(pthread_mutex_t *mute);</p>
<p>参数说明:</p>
<p>mutex为需要解锁的互斥锁；</p>
<h3 id="查看条件变量相关接口函数："><a href="#查看条件变量相关接口函数：" class="headerlink" title="查看条件变量相关接口函数："></a>查看条件变量相关接口函数：</h3><p>条件变量是利用<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BA%BF%E7%A8%8B/103101">线程</a>间共享的全局变量进行同步的一种机制，主要包括两个动作：一个线程等待”条件变量的条件成立”而挂起；另一个线程使”条件成立”（给出条件成立信号）。为了防止竞争，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/8400584">条件变量</a>的使用总是和一个<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BA%92%E6%96%A5%E9%94%81/841823">互斥锁</a>结合在一起。</p>
<h4 id="初始化条件变量"><a href="#初始化条件变量" class="headerlink" title="初始化条件变量"></a>初始化条件变量</h4><p>int pthread_cond_init(pthread_cond_t *cond, pthread_condattr_t *cond_attr)；</p>
<p>参数说明:</p>
<p>1.cond为初始化的条件变量，是一个指向结构pthread_cond_t的指针；</p>
<p>2.cond_attr为cond_attr是一个指向结构pthread_condattr_t的指针；</p>
<h4 id="销毁条件变量"><a href="#销毁条件变量" class="headerlink" title="销毁条件变量"></a>销毁条件变量</h4><p>int pthread_cond_destroy(pthread_cond_t *cond)；</p>
<p>参数说明:</p>
<p>cond为销毁的条件变量；</p>
<h4 id="等待条件变量成立"><a href="#等待条件变量成立" class="headerlink" title="等待条件变量成立"></a>等待条件变量成立</h4><p>int pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mutex) </p>
<h4 id="激活一个等待该条件变量的线程"><a href="#激活一个等待该条件变量的线程" class="headerlink" title="激活一个等待该条件变量的线程"></a>激活一个等待该条件变量的线程</h4><p>int pthread_cond_signal(pthread_cond_t *__cond);</p>
<p>存在多个等待线程时按入队顺序激活其中一个</p>
<h2 id="2、创建数据结构"><a href="#2、创建数据结构" class="headerlink" title="2、创建数据结构"></a>2、创建数据结构</h2><h3 id="任务结构体"><a href="#任务结构体" class="headerlink" title="任务结构体"></a>任务结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task</span></span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-keyword">void</span> *(*task)(<span class="hljs-keyword">void</span> *arg);	<span class="hljs-comment">/* 任务需要执行的函数 */</span><br>	<span class="hljs-keyword">void</span> *arg;					<span class="hljs-comment">/* 执行函数的参数 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task</span> *<span class="hljs-title">next</span>;</span>			<span class="hljs-comment">/* 下一个任务的地址 */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="线程池结构体"><a href="#线程池结构体" class="headerlink" title="线程池结构体"></a>线程池结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_pool</span></span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-keyword">pthread_mutex_t</span> lock;<br>	<span class="hljs-keyword">pthread_cond_t</span>  cond;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task</span> *<span class="hljs-title">task_list</span>;</span>	<span class="hljs-comment">/*链表结构，线程池中所有等待任务*/</span><br>	<span class="hljs-keyword">pthread_t</span> *tids;		<span class="hljs-comment">/*存放线程id的指针*/</span><br>	<span class="hljs-keyword">unsigned</span> waiting_tasks; <span class="hljs-comment">/*当前等待的任务数*/</span><br>	<span class="hljs-keyword">unsigned</span> active_threads;<span class="hljs-comment">/*线程池中线程数目*/</span><br>	<span class="hljs-keyword">bool</span> shutdown;			<span class="hljs-comment">/*是否销毁线程池*/</span><br>&#125;thread_pool;<br></code></pre></td></tr></table></figure>

<h2 id="3、线程池函数"><a href="#3、线程池函数" class="headerlink" title="3、线程池函数"></a>3、线程池函数</h2><h4 id="初始化线程池"><a href="#初始化线程池" class="headerlink" title="初始化线程池"></a>初始化线程池</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 初始化线程池</span><br><span class="hljs-comment"> * @param &#123;thread_pool*&#125; pool:线程池结构体指针 &#123;unsigned int&#125; max_thread_num: 创建几个线程</span><br><span class="hljs-comment"> * @return: false 失败 true 成功</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">init_pool</span><span class="hljs-params">(thread_pool *pool, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> threads_number)</span></span><br><span class="hljs-function"></span>&#123;<br>	pthread_mutex_init(&amp;pool-&gt;lock, <span class="hljs-literal">NULL</span>);	<span class="hljs-comment">/*初始化线程锁*/</span><br>	pthread_cond_init(&amp;pool-&gt;cond, <span class="hljs-literal">NULL</span>);	<span class="hljs-comment">/*初始化条件变量*/</span><br><br>	pool-&gt;shutdown = <span class="hljs-literal">false</span>;					<br>	pool-&gt;task_list = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(struct task));<br>	pool-&gt;tids = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">pthread_t</span>) * MAX_ACTIVE_THREADS);<br><br>	<span class="hljs-keyword">if</span>(pool-&gt;task_list == <span class="hljs-literal">NULL</span> || pool-&gt;tids == <span class="hljs-literal">NULL</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;allocate memory error&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	pool-&gt;task_list-&gt;next = <span class="hljs-literal">NULL</span>;<br><br>	pool-&gt;waiting_tasks = <span class="hljs-number">0</span>;<br>	pool-&gt;active_threads = threads_number;<br><br>	<span class="hljs-keyword">int</span> i;<br>	<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pool-&gt;active_threads; i++)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(pthread_create(&amp;((pool-&gt;tids)[i]), <span class="hljs-literal">NULL</span>,<br>					routine, (<span class="hljs-keyword">void</span> *)pool) != <span class="hljs-number">0</span>)<br>		&#123;<br>			perror(<span class="hljs-string">&quot;create threads error&quot;</span>);<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="向线程池添加任务"><a href="#向线程池添加任务" class="headerlink" title="向线程池添加任务"></a>向线程池添加任务</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 向线程池添加任务</span><br><span class="hljs-comment"> * @param &#123;thread_pool*&#125; pool:线程池结构体指针 &#123;void *(void *arg)&#125; (*task): 线程的回调函数 &#123;void *&#125; arg: 传入的参数</span><br><span class="hljs-comment"> * @return: false 失败 true 成功</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">add_task</span><span class="hljs-params">(thread_pool *pool,</span></span><br><span class="hljs-function"><span class="hljs-params">			<span class="hljs-keyword">void</span> *(*task)(<span class="hljs-keyword">void</span> *arg), <span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task</span> *<span class="hljs-title">new_task</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(struct task));<br>	<span class="hljs-keyword">if</span>(new_task == <span class="hljs-literal">NULL</span>)<br>	&#123;<br>		perror(<span class="hljs-string">&quot;allocate memory error&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br>	new_task-&gt;task = task;<br>	new_task-&gt;arg = arg;<br>	new_task-&gt;next = <span class="hljs-literal">NULL</span>;<br><br><br>	pthread_mutex_lock(&amp;pool-&gt;lock);<br>	<span class="hljs-keyword">if</span>(pool-&gt;waiting_tasks &gt;= MAX_WAITING_TASKS)<br>	&#123;<br>		pthread_mutex_unlock(&amp;pool-&gt;lock);<br><br>		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;too many tasks.\n&quot;</span>);<br>		<span class="hljs-built_in">free</span>(new_task);<br><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br>	<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task</span> *<span class="hljs-title">tmp</span> =</span> pool-&gt;task_list;<br>	<span class="hljs-keyword">while</span>(tmp-&gt;next != <span class="hljs-literal">NULL</span>)<br>		tmp = tmp-&gt;next;<br><br>	tmp-&gt;next = new_task;<br>	pool-&gt;waiting_tasks++;<br><br><br>	pthread_mutex_unlock(&amp;pool-&gt;lock);<br>	pthread_cond_signal(&amp;pool-&gt;cond);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="向线程池添加线程"><a href="#向线程池添加线程" class="headerlink" title="向线程池添加线程"></a>向线程池添加线程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 向线程池添加线程</span><br><span class="hljs-comment"> * @param &#123;thread_pool*&#125; pool:线程池结构体指针 &#123;unsigned int&#125; additional_threads: 添加的线程数</span><br><span class="hljs-comment"> * @return: 返回成功的线程数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">add_thread</span><span class="hljs-params">(thread_pool *pool, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> additional_threads)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(additional_threads == <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> total_threads =<br>		     pool-&gt;active_threads + additional_threads;<br><br>	<span class="hljs-keyword">int</span> i, actual_increment = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(i = pool-&gt;active_threads;<br>	    i &lt; total_threads &amp;&amp; i &lt; MAX_ACTIVE_THREADS;<br>	    i++)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(pthread_create(&amp;((pool-&gt;tids)[i]),<br>				<span class="hljs-literal">NULL</span>, routine, (<span class="hljs-keyword">void</span> *)pool) != <span class="hljs-number">0</span>)<br>		&#123;<br>			perror(<span class="hljs-string">&quot;add threads error&quot;</span>);<br><br>			<span class="hljs-keyword">if</span>(actual_increment == <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>		actual_increment++; <br>	&#125;<br><br>	pool-&gt;active_threads += actual_increment;<br>	<span class="hljs-keyword">return</span> actual_increment;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="线程的回调处理函数"><a href="#线程的回调处理函数" class="headerlink" title="线程的回调处理函数"></a>线程的回调处理函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 回调处理函数</span><br><span class="hljs-comment"> * @param  &#123;void *&#125; arg: 传入的参数</span><br><span class="hljs-comment"> * @return: 无</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">handler</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br><br>	pthread_mutex_unlock((<span class="hljs-keyword">pthread_mutex_t</span> *)arg);<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 线程的回调处理函数</span><br><span class="hljs-comment"> * @param  &#123;void *&#125; arg: 传入的参数</span><br><span class="hljs-comment"> * @return: 无</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">routine</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>	thread_pool *pool = (thread_pool *)arg;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task</span> *<span class="hljs-title">p</span>;</span><br><br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>	&#123;<br><br>		pthread_cleanup_push(handler, (<span class="hljs-keyword">void</span> *)&amp;pool-&gt;lock);<br>		pthread_mutex_lock(&amp;pool-&gt;lock);<br><br><br>		<span class="hljs-keyword">while</span>(pool-&gt;waiting_tasks == <span class="hljs-number">0</span> &amp;&amp; !pool-&gt;shutdown)<br>		&#123;<br>			pthread_cond_wait(&amp;pool-&gt;cond, &amp;pool-&gt;lock);<br>		&#125;<br><br><br>		<span class="hljs-keyword">if</span>(pool-&gt;waiting_tasks == <span class="hljs-number">0</span> &amp;&amp; pool-&gt;shutdown == <span class="hljs-literal">true</span>)<br>		&#123;<br>			pthread_mutex_unlock(&amp;pool-&gt;lock);<br>			pthread_exit(<span class="hljs-literal">NULL</span>);<br>		&#125;<br><br><br>		p = pool-&gt;task_list-&gt;next;<br>		pool-&gt;task_list-&gt;next = p-&gt;next;<br>		pool-&gt;waiting_tasks--;<br><br><br>		pthread_mutex_unlock(&amp;pool-&gt;lock);<br>		pthread_cleanup_pop(<span class="hljs-number">0</span>);<br><br><br>		pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, <span class="hljs-literal">NULL</span>);<br>		(p-&gt;task)(p-&gt;arg);<br>		pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, <span class="hljs-literal">NULL</span>);<br><br>		<span class="hljs-built_in">free</span>(p);<br>	&#125;<br><br>	pthread_exit(<span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="线程池里取消线程"><a href="#线程池里取消线程" class="headerlink" title="线程池里取消线程"></a>线程池里取消线程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 线程池里取消线程</span><br><span class="hljs-comment"> * @param &#123;thread_pool*&#125; pool:线程池结构体指针 &#123;nsigned int&#125; removing_threads: 取消的线程数</span><br><span class="hljs-comment"> * @return: 失败返回-1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">remove_thread</span><span class="hljs-params">(thread_pool *pool, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> removing_threads)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(removing_threads == <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> pool-&gt;active_threads;<br><br>	<span class="hljs-keyword">int</span> remain_threads = pool-&gt;active_threads - removing_threads;<br>	remain_threads = remain_threads&gt;<span class="hljs-number">0</span> ? remain_threads:<span class="hljs-number">1</span>;<br><br>	<span class="hljs-keyword">int</span> i;<br>	<span class="hljs-keyword">for</span>(i=pool-&gt;active_threads<span class="hljs-number">-1</span>; i&gt;remain_threads<span class="hljs-number">-1</span>; i--)<br>	&#123;<br>		errno = pthread_cancel(pool-&gt;tids[i]);<br>		<span class="hljs-keyword">if</span>(errno != <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(i == pool-&gt;active_threads<span class="hljs-number">-1</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		pool-&gt;active_threads = i+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">return</span> i+<span class="hljs-number">1</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="销毁线程池"><a href="#销毁线程池" class="headerlink" title="销毁线程池"></a>销毁线程池</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description: 销毁线程池</span><br><span class="hljs-comment"> * @param &#123;thread_pool*&#125; pool:线程池结构体指针</span><br><span class="hljs-comment"> * @return: 成功返回true</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">destroy_pool</span><span class="hljs-params">(thread_pool *pool)</span></span><br><span class="hljs-function"></span>&#123;<br><br>	pool-&gt;shutdown = <span class="hljs-literal">true</span>;<br>	pthread_cond_broadcast(&amp;pool-&gt;cond);<br><br>	<span class="hljs-keyword">int</span> i;<br>	<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pool-&gt;active_threads; i++)<br>	&#123;<br>		errno = pthread_join(pool-&gt;tids[i], <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span>(errno != <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;join tids[%d] error: %s\n&quot;</span>,<br>					i, strerror(errno));<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%u] is joined\n&quot;</span>, (<span class="hljs-keyword">unsigned</span>)pool-&gt;tids[i]);<br>		<br>	&#125;<br><br>	<span class="hljs-built_in">free</span>(pool-&gt;task_list);<br>	<span class="hljs-built_in">free</span>(pool-&gt;tids);<br>	<span class="hljs-built_in">free</span>(pool);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4、完整代码"><a href="#4、完整代码" class="headerlink" title="4、完整代码"></a>4、完整代码</h2><p>由于篇幅较长就不贴出来 代码放百度云，需要的在微信公众号回复【线程】即可获取链接下载</p>
<p>使用：Linux下进入文件夹执行make生成可执行文件test执行即可</p>
<p><img src="https://gitee.com/coderhackett/typoraimg/raw/master/image/20210630224552.png" alt="image-20210630224505511"></p>
<p>如果你觉得文章还不错，可以给个”<strong>三连</strong>“</p>
<p>我是<strong>加班猿</strong>，我们下期见</p>
<p><img src="https://img-blog.csdnimg.cn/20201029203206698.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzM3ODI0MzU3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/03/13/STL%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/">STL核心编程 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: 'Nq5lj4VJyzKxDJIKCQ8wQAWs-gzGzoHsz'
 , appKey: 'RSAaB7CGtQpU2kjI3iFgD7Rz'
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/coderhackett"> Dr.hackett</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">16</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">9</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">8</span></div></section></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#C%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">1.</span> <span class="toc-text">C线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.1.</span> <span class="toc-text">1、准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">查看线程相关接口函数：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">线程创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%80%80%E5%87%BA"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">线程退出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%AD%89%E5%BE%85"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">线程等待</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%8F%96%E6%B6%88"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">线程取消</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%BA%BF%E7%A8%8B%E7%9A%84cancle%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">设置线程的cancle信号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">清理线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BF%80%E6%B4%BB%E6%89%80%E6%9C%89%E7%AD%89%E5%BE%85%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">激活所有等待线程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BA%92%E6%96%A5%E9%94%81%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">查看互斥锁相关接口函数：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">创建互斥锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%80%E6%AF%81%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">销毁互斥锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">上互斥锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">解互斥锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.1.3.</span> <span class="toc-text">查看条件变量相关接口函数：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">初始化条件变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%80%E6%AF%81%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">销毁条件变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E6%88%90%E7%AB%8B"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">等待条件变量成立</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BF%80%E6%B4%BB%E4%B8%80%E4%B8%AA%E7%AD%89%E5%BE%85%E8%AF%A5%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">激活一个等待该条件变量的线程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">2、创建数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.2.1.</span> <span class="toc-text">任务结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">线程池结构体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">3、线程池函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">初始化线程池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%91%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">向线程池添加任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%91%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%B7%BB%E5%8A%A0%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.0.3.</span> <span class="toc-text">向线程池添加线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%9B%9E%E8%B0%83%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.0.4.</span> <span class="toc-text">线程的回调处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%87%8C%E5%8F%96%E6%B6%88%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.0.5.</span> <span class="toc-text">线程池里取消线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%80%E6%AF%81%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">1.3.0.6.</span> <span class="toc-text">销毁线程池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.</span> <span class="toc-text">4、完整代码</span></a></li></ol></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>